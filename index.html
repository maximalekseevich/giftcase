<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Звездный Кейс</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background-color: #121212;
            color: #FFFFFF;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }
        .container {
            width: 100%;
            max-width: 400px;
        }
        h1 {
            font-size: 28px;
            text-align: center;
            margin-bottom: 15px;
        }
        .user-info {
            margin-bottom: 15px;
            text-align: center;
        }
        .nav {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
        }
        .nav button {
            position: relative;
            background-color: #40C4FF;
            color: #FFFFFF;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            z-index: 1;
        }
        .nav button::before {
            content: '';
            position: absolute;
            left: -25px;
            top: 0;
            width: 20px;
            height: 50px;
            background-image: url('https://via.placeholder.com/20x50?text=Лиана');
            background-size: cover;
            pointer-events: none;
            z-index: 0;
        }
        .nav button::after {
            content: '';
            position: absolute;
            right: -25px;
            top: 0;
            width: 20px;
            height: 50px;
            background-image: url('https://via.placeholder.com/20x50?text=Лиана');
            background-size: cover;
            pointer-events: none;
            z-index: 0;
        }
        .nav button:hover {
            background-color: #0288D1;
        }
        .nav button.active {
            background-color: #0288D1;
        }
        .nav button.active:hover {
            background-color: #0277BD;
        }
        .section {
            background-color: #1E1E1E;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .section h2 {
            font-size: 20px;
            margin-bottom: 10px;
        }
        .case-buttons button {
            display: block;
            width: 100%;
            background-color: #40C4FF;
            color: #FFFFFF;
            border: none;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .case-buttons button:hover {
            background-color: #0288D1;
        }
        .case-buttons button:disabled {
            background-color: #616161;
            cursor: not-allowed;
        }
        #free-case-timer {
            text-align: center;
            margin-top: 5px;
            font-size: 12px;
            color: #B0BEC5;
        }
        #case-animation {
            display: none;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
        #case-animation img {
            width: 60px;
            height: 60px;
        }
        #case-result {
            display: none;
            text-align: center;
        }
        #case-result img {
            width: 60px;
            height: 60px;
            margin-bottom: 10px;
        }
        #inventory {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .inventory-item {
            background-color: #2C2C2C;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
        }
        .inventory-item img {
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }
        #tasks-section {
            background-image: url('https://via.placeholder.com/400x200?text=Задания');
            background-size: cover;
            background-position: center;
        }
        #tasks {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        .task {
            background-color: #2C2C2C;
            padding: 10px;
            border-radius: 5px;
        }
        .task p {
            margin: 5px 0;
        }
        .task button {
            background-color: #40C4FF;
            color: #FFFFFF;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .task button:hover {
            background-color: #0288D1;
        }
        .task button:disabled {
            background-color: #616161;
            cursor: not-allowed;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            0% { opacity: 0; transform: scale(0.5); }
            100% { opacity: 1; transform: scale(1); }
        }
        .spinning {
            animation: spin 1s linear infinite;
        }
        .reveal {
            animation: fadeIn 0.5s ease-out;
        }
        .donate-form {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }
        .donate-form input {
            flex: 1;
            padding: 5px;
            border: 1px solid #40C4FF;
            border-radius: 5px;
            background-color: #2C2C2C;
            color: #FFFFFF;
        }
        .donate-form button {
            padding: 5px 10px;
            background-color: #40C4FF;
            color: #FFFFFF;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .donate-form button:hover {
            background-color: #0288D1;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Звездный Кейс</h1>
        <div class="user-info">
            <p>Звезды: <span id="star-balance">25</span></p>
            <p>Получено донатов: <span id="donation-total">0</span> ⭐</p>
        </div>

        <div class="nav">
            <button id="show-cases" class="active">Кейсы</button>
            <button id="show-inventory">Инвентарь</button>
            <button id="show-tasks">Задания</button>
        </div>

        <div id="cases-section" class="section">
            <h2>Открыть кейс</h2>
            <div class="case-buttons">
                <button id="open-free-case">Бесплатный Кейс Новичка</button>
                <div id="free-case-timer"></div>
                <button id="open-beginner-case">Кейс Новичка (100 звезд)</button>
                <button id="open-amateur-case">Кейс Любителя (300 звезд)</button>
                <button id="open-pro-case">Кейс Профессионала (1000 звезд)</button>
                <button id="open-legend-case">Кейс Легенды (5000 звезд)</button>
                <button id="open-space-case">Космический кейс (2000 звезд)</button>
                <button id="open-holiday-case">Праздничный кейс (1500 звезд)</button>
                <button id="donate-button">Сделать донат (Telegram Stars)</button>
            </div>
            <div id="donate-form" class="donate-form hidden">
                <input type="number" id="donate-amount" min="1" placeholder="Сколько звезд?">
                <button id="confirm-donate">Подтвердить</button>
            </div>
            <div id="case-animation" class="hidden">
                <img src="https://via.placeholder.com/100?text=Кейс" alt="Кейс" class="spinning">
            </div>
            <div id="case-result" class="hidden">
                <img id="result-image" src="" alt="Результат" class="reveal">
                <p id="result-text"></p>
            </div>
        </div>

        <div id="inventory-section" class="section hidden">
            <h2>Ваш инвентарь</h2>
            <div id="inventory"></div>
        </div>

        <div id="tasks-section" class="section hidden">
            <h2>Ежедневные задания</h2>
            <p id="task-timer">Обновление через: <span id="timer">00:00:00</span></p>
            <div id="tasks"></div>
        </div>
    </div>

    <script>
        console.log('Инициализация Telegram Web App...');
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            console.log('Telegram Web App инициализирован');
        } else {
            console.error('Telegram Web App не найден');
        }

        const gifts = [
            { name: "Сердечко", value: 15, image: "https://via.placeholder.com/100?text=Сердечко" },
            { name: "Мишка", value: 15, image: "https://via.placeholder.com/100?text=Мишка" },
            { name: "Роза", value: 25, image: "https://via.placeholder.com/100?text=Роза" },
            { name: "Подарок", value: 25, image: "https://via.placeholder.com/100?text=Подарок" },
            { name: "Торт", value: 50, image: "https://via.placeholder.com/100?text=Торт" }
        ];

        const cases = [
            {
                name: "Бесплатный Кейс Новичка",
                cost: 0,
                drops: [
                    { gift: "Сердечко", chance: 0.87 },
                    { gift: "Мишка", chance: 0.1299 },
                    { gift: "Роза", chance: 0.001 }
                ]
            },
            {
                name: "Кейс Новичка",
                cost: 100,
                drops: [
                    { gift: "Сердечко", chance: 0.25 },
                    { gift: "Мишка", chance: 0.25 },
                    { gift: "Роза", chance: 0.20 },
                    { gift: "Подарок", chance: 0.15 },
                    { gift: "Торт", chance: 0.10 },
                    { gift: "Роза", chance: 0.05 }
                ]
            }
        ];

        const taskPool = [
            { id: "open-5-cases", description: "Открыть 5 кейсов", goal: 5, reward: 50 },
            { id: "beginner-3-gifts", description: "Получить 3 подарка из Кейса Новичка", goal: 3, reward: 20 }
        ];

        let starBalance = 25;
        let inventory = [];
        let dailyTasks = [];
        let lastTaskUpdate = null;
        let lastFreeCase = null;
        let donationTotal = 0;

        const starBalanceEl = document.getElementById('star-balance');
        const donationTotalEl = document.getElementById('donation-total');
        const openFreeCaseBtn = document.getElementById('open-free-case');
        const openBeginnerCaseBtn = document.getElementById('open-beginner-case');
        const openAmateurCaseBtn = document.getElementById('open-amateur-case');
        const openProCaseBtn = document.getElementById('open-pro-case');
        const openLegendCaseBtn = document.getElementById('open-legend-case');
        const openSpaceCaseBtn = document.getElementById('open-space-case');
        const openHolidayCaseBtn = document.getElementById('open-holiday-case');
        const donateButton = document.getElementById('donate-button');
        const donateForm = document.getElementById('donate-form');
        const donateAmount = document.getElementById('donate-amount');
        const confirmDonate = document.getElementById('confirm-donate');
        const freeCaseTimerEl = document.getElementById('free-case-timer');
        const caseAnimationEl = document.getElementById('case-animation');
        const caseResultEl = document.getElementById('case-result');
        const resultImageEl = document.getElementById('result-image');
        const resultTextEl = document.getElementById('result-text');
        const inventoryEl = document.getElementById('inventory');
        const casesSection = document.getElementById('cases-section');
        const inventorySection = document.getElementById('inventory-section');
        const tasksSection = document.getElementById('tasks-section');
        const timerEl = document.getElementById('timer');
        const showCasesBtn = document.getElementById('show-cases');
        const showInventoryBtn = document.getElementById('show-inventory');
        const showTasksBtn = document.getElementById('show-tasks');

        function updateStarBalance() {
            starBalanceEl.textContent = starBalance;
            donationTotalEl.textContent = donationTotal;
        }

        function updateInventory() {
            inventoryEl.innerHTML = '';
            inventory.forEach(item => {
                const gift = gifts.find(g => g.name === item);
                if (gift) {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'inventory-item';
                    itemEl.innerHTML = `
                        <img src="${gift.image}" alt="${gift.name}">
                        <div>
                            <p>${gift.name}</p>
                            <p>${gift.value} звезд</p>
                        </div>
                    `;
                    inventoryEl.appendChild(itemEl);
                }
            });
        }

        function selectDailyTasks() {
            dailyTasks = [];
            const shuffled = taskPool.sort(() => 0.5 - Math.random());
            dailyTasks = shuffled.slice(0, 2).map(task => ({
                id: task.id,
                description: task.description,
                goal: task.goal,
                reward: task.reward,
                completed: false,
                progress: 0
            }));
            lastTaskUpdate = new Date().toISOString().split('T')[0];
            updateTasks();
        }

        function updateTasks() {
            const tasksEl = document.getElementById('tasks');
            tasksEl.innerHTML = '';
            dailyTasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'task';
                taskEl.innerHTML = `
                    <p>${task.description}</p>
                    <p>Прогресс: ${task.progress}/${task.goal} | Награда: ${task.reward} звезд</p>
                    <button class="claim-task" data-task="${task.id}" ${task.progress >= task.goal && !task.completed ? '' : 'disabled'}>Получить</button>
                `;
                tasksEl.appendChild(taskEl);
            });
            document.querySelectorAll('.claim-task').forEach(button => {
                button.addEventListener('click', () => {
                    const taskId = button.getAttribute('data-task');
                    const task = dailyTasks.find(t => t.id === taskId);
                    if (task.progress >= task.goal && !task.completed) {
                        starBalance += task.reward;
                        task.completed = true;
                        updateStarBalance();
                        updateTasks();
                        alert(`Задание выполнено! Получено ${task.reward} звезд.`);
                    }
                });
            });
        }

        function updateTimer() {
            const now = new Date();
            const mskOffset = 3 * 60 * 60 * 1000;
            const utc = now.getTime() + (now.getTimezoneOffset() * 60 * 1000);
            const mskTime = new Date(utc + mskOffset);
            const nextMidnight = new Date(mskTime);
            nextMidnight.setHours(24, 0, 0, 0);
            const timeLeft = nextMidnight - mskTime;
            if (timeLeft <= 0) {
                selectDailyTasks();
                return;
            }
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            timerEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateFreeCaseTimer() {
            const now = Date.now();
            const freeCaseCooldown = 72 * 60 * 60 * 1000;
            let canOpenFreeCase = true;
            if (lastFreeCase) {
                const timeSinceLastFreeCase = now - parseInt(lastFreeCase);
                if (timeSinceLastFreeCase < freeCaseCooldown) {
                    canOpenFreeCase = false;
                    const timeLeft = freeCaseCooldown - timeSinceLastFreeCase;
                    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                    freeCaseTimerEl.textContent = `Доступно через: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    openFreeCaseBtn.disabled = true;
                } else {
                    freeCaseTimerEl.textContent = 'Доступно!';
                    openFreeCaseBtn.disabled = false;
                }
            } else {
                freeCaseTimerEl.textContent = 'Доступно!';
                openFreeCaseBtn.disabled = false;
            }
            return canOpenFreeCase;
        }

        function getRandomGift(caseData) {
            const rand = Math.random();
            let cumulative = 0;
            for (const drop of caseData.drops) {
                cumulative += drop.chance;
                if (rand <= cumulative) {
                    return drop.gift;
                }
            }
            return caseData.drops[0].gift;
        }

        function openCase(caseData) {
            let canOpen = true;
            if (caseData.name === "Бесплатный Кейс Новичка") {
                canOpen = updateFreeCaseTimer();
            } else if (starBalance < caseData.cost) {
                alert('Недостаточно звезд!');
                return;
            }
            if (canOpen) {
                if (caseData.name !== "Бесплатный Кейс Новичка") {
                    starBalance -= caseData.cost;
                    updateStarBalance();
                } else {
                    lastFreeCase = Date.now();
                }
                dailyTasks.forEach(task => {
                    if (task.id === "open-5-cases" || task.id === "beginner-3-gifts") task.progress++;
                });
                caseAnimationEl.style.display = 'flex';
                caseResultEl.style.display = 'none';
                setTimeout(() => {
                    const giftName = getRandomGift(caseData);
                    const gift = gifts.find(g => g.name === giftName);
                    inventory.push(giftName);
                    updateInventory();
                    caseAnimationEl.style.display = 'none';
                    resultImageEl.src = gift.image;
                    resultTextEl.textContent = `Вы получили: ${gift.name}!`;
                    caseResultEl.style.display = 'block';
                    updateFreeCaseTimer();
                }, 2000);
            }
        }

        function sendDonateInvoice(amount) {
            console.log('Отправка инвойса для доната:', amount);
            const tg = window.Telegram?.WebApp;
            const user = tg?.initDataUnsafe.user;
            if (user) {
                fetch('/api/create-invoice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: user.id,
                        amount: amount,
                        payload: `donate_${user.id}_${Date.now()}`
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        caseAnimationEl.style.display = 'flex';
                        alert('Пожалуйста, подтвердите оплату в Telegram.');
                    } else {
                        alert('Ошибка при создании инвойса.');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Произошла ошибка. Попробуйте позже.');
                });
            } else {
                alert('Не удалось получить данные пользователя.');
            }
        }

        openFreeCaseBtn.addEventListener('click', () => openCase(cases[0]));
        openBeginnerCaseBtn.addEventListener('click', () => openCase(cases[1]));
        donateButton.addEventListener('click', () => {
            donateForm.classList.remove('hidden');
            donateAmount.focus();
        });
        confirmDonate.addEventListener('click', () => {
            const amount = parseInt(donateAmount.value);
            if (amount && amount > 0) {
                sendDonateInvoice(amount);
                donateAmount.value = '';
            } else {
                alert('Пожалуйста, введите сумму больше 0.');
            }
        });
        window.addEventListener('message', (event) => {
            if (event.data.type === 'donationSuccess') {
                const { amount } = event.data;
                const tg = window.Telegram?.WebApp;
                const user = tg?.initDataUnsafe.user;
                if (user) {
                    fetch(`/api/update-balance?userId=${user.id}&amount=${amount}`, {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            starBalance += amount;
                            donationTotal += amount;
                            caseAnimationEl.style.display = 'none';
                            updateStarBalance();
                            alert(`Спасибо за донат на ${amount} ⭐!`);
                        }
                    });
                }
            }
        });

        showCasesBtn.addEventListener('click', () => {
            casesSection.style.display = 'block';
            inventorySection.style.display = 'none';
            tasksSection.style.display = 'none';
            showCasesBtn.classList.add('active');
            showInventoryBtn.classList.remove('active');
            showTasksBtn.classList.remove('active');
        });
        showInventoryBtn.addEventListener('click', () => {
            casesSection.style.display = 'none';
            inventorySection.style.display = 'block';
            tasksSection.style.display = 'none';
            showCasesBtn.classList.remove('active');
            showInventoryBtn.classList.add('active');
            showTasksBtn.classList.remove('active');
        });
        showTasksBtn.addEventListener('click', () => {
            casesSection.style.display = 'none';
            inventorySection.style.display = 'none';
            tasksSection.style.display = 'block';
            showCasesBtn.classList.remove('active');
            showInventoryBtn.classList.remove('active');
            showTasksBtn.classList.add('active');
        });

        selectDailyTasks();
        updateStarBalance();
        updateInventory();
        updateTimer();
        setInterval(updateTimer, 1000);
        updateFreeCaseTimer();
        setInterval(updateFreeCaseTimer, 1000);
    </script>
</body>
</html>
