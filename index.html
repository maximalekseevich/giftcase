<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Звездный Кейс</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background-color: #1C2526;
            color: #FFFFFF;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }
        .container {
            width: 100%;
            max-width: 400px;
        }
        h1 {
            font-size: 28px;
            text-align: center;
            margin-bottom: 15px;
        }
        .user-info {
            margin-bottom: 15px;
            text-align: center;
        }
        .nav {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
        }
        .nav button {
            position: relative;
            background-color: #2ECC71;
            color: #FFFFFF;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            z-index: 1;
        }
        .nav button::before {
            content: '';
            position: absolute;
            left: -25px;
            top: 0;
            width: 20px;
            height: 50px;
            background-image: url('https://via.placeholder.com/20x50?text=Лиана');
            background-size: cover;
            pointer-events: none;
            z-index: 0;
        }
        .nav button::after {
            content: '';
            position: absolute;
            right: -25px;
            top: 0;
            width: 20px;
            height: 50px;
            background-image: url('https://via.placeholder.com/20x50?text=Лиана');
            background-size: cover;
            pointer-events: none;
            z-index: 0;
        }
        .nav button:hover {
            background-color: #27AE60;
        }
        .nav button.active {
            background-color: #9B59B6;
        }
        .nav button.active:hover {
            background-color: #8E44AD;
        }
        .section {
            background-color: #2C3E50;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .section h2 {
            font-size: 20px;
            margin-bottom: 10px;
        }
        .case-buttons button {
            display: block;
            width: 100%;
            background-color: #2ECC71;
            color: #FFFFFF;
            border: none;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .case-buttons button:hover {
            background-color: #27AE60;
        }
        .case-buttons button:disabled {
            background-color: #7F8C8D;
            cursor: not-allowed;
        }
        #case-animation {
            display: none;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
        #case-animation img {
            width: 60px;
            height: 60px;
        }
        #case-result {
            display: none;
            text-align: center;
        }
        #case-result img {
            width: 60px;
            height: 60px;
            margin-bottom: 10px;
        }
        #inventory {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .inventory-item {
            background-color: #34495E;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
        }
        .inventory-item img {
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }
        #tasks-section {
            background-image: url('https://via.placeholder.com/400x200?text=Задания');
            background-size: cover;
            background-position: center;
        }
        #tasks {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        .task {
            background-color: #34495E;
            padding: 10px;
            border-radius: 5px;
        }
        .task p {
            margin: 5px 0;
        }
        .task button {
            background-color: #9B59B6;
            color: #FFFFFF;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .task button:hover {
            background-color: #8E44AD;
        }
        .task button:disabled {
            background-color: #7F8C8D;
            cursor: not-allowed;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            0% { opacity: 0; transform: scale(0.5); }
            100% { opacity: 1; transform: scale(1); }
        }
        .spinning {
            animation: spin 1s linear infinite;
        }
        .reveal {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Звездный Кейс</h1>
        <div class="user-info">
            <p>Звезды: <span id="star-balance">1000</span></p>
        </div>

        <!-- Навигация -->
        <div class="nav">
            <button id="show-cases" class="active">Кейсы</button>
            <button id="show-inventory">Инвентарь</button>
            <button id="show-tasks">Задания</button>
        </div>

        <!-- Секция открытия кейсов -->
        <div id="cases-section" class="section">
            <h2>Открыть кейс</h2>
            <div class="case-buttons">
                <button id="open-beginner-case">Кейс Новичка (100 звезд)</button>
                <button id="open-amateur-case">Кейс Любителя (300 звезд)</button>
                <button id="open-pro-case">Кейс Профессионала (1000 звезд)</button>
                <button id="open-legend-case">Кейс Легенды (5000 звезд)</button>
                <button id="open-space-case">Космический кейс (2000 звезд)</button>
                <button id="open-holiday-case">Праздничный кейс (1500 звезд)</button>
            </div>
            <div id="case-animation" class="hidden">
                <img src="https://via.placeholder.com/100?text=Кейс" alt="Кейс" class="spinning">
            </div>
            <div id="case-result" class="hidden">
                <img id="result-image" src="" alt="Результат" class="reveal">
                <p id="result-text"></p>
            </div>
        </div>

        <!-- Секция инвентаря -->
        <div id="inventory-section" class="section hidden">
            <h2>Ваш инвентарь</h2>
            <div id="inventory"></div>
        </div>

        <!-- Секция заданий -->
        <div id="tasks-section" class="section hidden">
            <h2>Ежедневные задания</h2>
            <p id="task-timer">Обновление через: <span id="timer">00:00:00</span></p>
            <div id="tasks"></div>
        </div>
    </div>

    <script>
        // Проверка Telegram Web App
        console.log('Инициализация Telegram Web App...');
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            console.log('Telegram Web App инициализирован');
        } else {
            console.error('Telegram Web App не найден');
        }

        // Данные подарков
        const gifts = [
            { name: "Сердечко", value: 15, image: "https://via.placeholder.com/100?text=Сердечко" },
            { name: "Мишка", value: 15, image: "https://via.placeholder.com/100?text=Мишка" },
            { name: "Роза", value: 25, image: "https://via.placeholder.com/100?text=Роза" },
            { name: "Подарок", value: 25, image: "https://via.placeholder.com/100?text=Подарок" },
            { name: "Торт", value: 50, image: "https://via.placeholder.com/100?text=Торт" },
            { name: "Букет", value: 50, image: "https://via.placeholder.com/100?text=Букет" },
            { name: "Ракета", value: 50, image: "https://via.placeholder.com/100?text=Ракета" },
            { name: "Кубок", value: 100, image: "https://via.placeholder.com/100?text=Кубок" },
            { name: "Кольцо", value: 100, image: "https://via.placeholder.com/100?text=Кольцо" },
            { name: "Алмаз", value: 100, image: "https://via.placeholder.com/100?text=Алмаз" },
            { name: "Шампанское", value: 50, image: "https://via.placeholder.com/100?text=Шампанское" },
            { name: "Носки", value: 100, image: "https://via.placeholder.com/100?text=Носки" },
            { name: "Пепе", value: 1200000, image: "https://via.placeholder.com/100?text=Пепе" },
            { name: "Кнопка с сердечком", value: 200, image: "https://via.placeholder.com/100?text=Кнопка+Сердце" },
            { name: "Доширак", value: 50, image: "https://via.placeholder.com/100?text=Доширак" },
            { name: "Кирпич 1 апреля", value: 5000, image: "https://via.placeholder.com/100?text=Кирпич" },
            { name: "1 мая", value: 100, image: "https://via.placeholder.com/100?text=1+Мая" },
            { name: "Красная звезда", value: 100, image: "https://via.placeholder.com/100?text=Красная+Звезда" },
            { name: "Факел свободы", value: 150, image: "https://via.placeholder.com/100?text=Факел" },
            { name: "Мини-статуя свободы", value: 250, image: "https://via.placeholder.com/100?text=Статуя" },
            { name: "Орел свободы", value: 5000, image: "https://via.placeholder.com/100?text=Орел" },
            { name: "Пряник", value: 555, image: "https://via.placeholder.com/100?text=Пряник" },
            { name: "Какашка", value: 50, image: "https://via.placeholder.com/100?text=Какашка" },
            { name: "Золотое сердце", value: 100, image: "https://via.placeholder.com/100?text=Золотое+Сердце" },
            { name: "Корона", value: 500, image: "https://via.placeholder.com/100?text=Корона" },
            { name: "Единорог", value: 1000, image: "https://via.placeholder.com/100?text=Единорог" },
            { name: "Звезда", value: 2500, image: "https://via.placeholder.com/100?text=Звезда" },
            { name: "Подарочная коробка", value: 75, image: "https://via.placeholder.com/100?text=Подарочная+Коробка" },
            { name: "Меч Star Wars", value: 1000, image: "https://via.placeholder.com/100?text=Меч+Star+Wars" },
            { name: "Маска", value: 500, image: "https://via.placeholder.com/100?text=Маска" }
        ];

        // Данные кейсов
        const cases = [
            {
                name: "Кейс Новичка",
                cost: 100,
                drops: [
                    { gift: "Сердечко", chance: 0.25 },
                    { gift: "Мишка", chance: 0.25 },
                    { gift: "Роза", chance: 0.20 },
                    { gift: "Подарок", chance: 0.15 },
                    { gift: "Какашка", chance: 0.10 },
                    { gift: "Подарочная коробка", chance: 0.05 }
                ]
            },
            {
                name: "Кейс Любителя",
                cost: 300,
                drops: [
                    { gift: "Торт", chance: 0.25 },
                    { gift: "Букет", chance: 0.25 },
                    { gift: "Ракета", chance: 0.20 },
                    { gift: "Шампанское", chance: 0.15 },
                    { gift: "Доширак", chance: 0.10 },
                    { gift: "Золотое сердце", chance: 0.05 }
                ]
            },
            {
                name: "Кейс Профессионала",
                cost: 1000,
                drops: [
                    { gift: "Кубок", chance: 0.20 },
                    { gift: "Кольцо", chance: 0.20 },
                    { gift: "Алмаз", chance: 0.15 },
                    { gift: "Носки", chance: 0.15 },
                    { gift: "1 мая", chance: 0.10 },
                    { gift: "Красная звезда", chance: 0.10 },
                    { gift: "Факел свободы", chance: 0.05 },
                    { gift: "Корона", chance: 0.03 },
                    { gift: "Маска", chance: 0.02 }
                ]
            },
            {
                name: "Кейс Легенды",
                cost: 5000,
                drops: [
                    { gift: "Мини-статуя свободы", chance: 0.249 },
                    { gift: "Пряник", chance: 0.20 },
                    { gift: "Единорог", chance: 0.15 },
                    { gift: "Звезда", chance: 0.15 },
                    { gift: "Орел свободы", chance: 0.10 },
                    { gift: "Кирпич 1 апреля", chance: 0.05 },
                    { gift: "Меч Star Wars", chance: 0.05 },
                    { gift: "Пепе", chance: 0.001 }
                ]
            },
            {
                name: "Космический кейс",
                cost: 2000,
                drops: [
                    { gift: "Ракета", chance: 0.40 },
                    { gift: "Красная звезда", chance: 0.30 },
                    { gift: "Звезда", chance: 0.20 },
                    { gift: "Меч Star Wars", chance: 0.10 }
                ]
            },
            {
                name: "Праздничный кейс",
                cost: 1500,
                drops: [
                    { gift: "Торт", chance: 0.30 },
                    { gift: "Подарочная коробка", chance: 0.30 },
                    { gift: "Пряник", chance: 0.20 },
                    { gift: "Шампанское", chance: 0.15 },
                    { gift: "1 мая", chance: 0.05 }
                ]
            }
        ];

        // Пул заданий
        const taskPool = [
            { id: "open-5-cases", description: "Открыть 5 кейсов", goal: 5, reward: 50 },
            { id: "beginner-3-gifts", description: "Получить 3 подарка из Кейса Новичка", goal: 3, reward: 20 },
            { id: "open-legend", description: "Открыть Кейс Легенды", goal: 1, reward: 100 },
            { id: "visit-inventory", description: "Посетить инвентарь", goal: 1, reward: 10 },
            { id: "open-2-space", description: "Открыть 2 Космических кейса", goal: 2, reward: 75 },
            { id: "gift-100-plus", description: "Получить подарок стоимостью 100+ звезд", goal: 1, reward: 30 },
            { id: "open-3-cases", description: "Открыть 3 кейса любого типа", goal: 3, reward: 40 },
            { id: "holiday-2-gifts", description: "Получить 2 подарка из Праздничного кейса", goal: 2, reward: 50 },
            { id: "open-pro", description: "Открыть Кейс Профессионала", goal: 1, reward: 60 },
            { id: "amateur-5-gifts", description: "Получить 5 подарков из Кейса Любителя", goal: 5, reward: 25 }
        ];

        // Состояние
        let starBalance = 1000;
        let inventory = [];
        let dailyTasks = [];
        let lastTaskUpdate = null;

        // Элементы DOM
        const starBalanceEl = document.getElementById('star-balance');
        const openBeginnerCaseBtn = document.getElementById('open-beginner-case');
        const openAmateurCaseBtn = document.getElementById('open-amateur-case');
        const openProCaseBtn = document.getElementById('open-pro-case');
        const openLegendCaseBtn = document.getElementById('open-legend-case');
        const openSpaceCaseBtn = document.getElementById('open-space-case');
        const openHolidayCaseBtn = document.getElementById('open-holiday-case');
        const caseAnimationEl = document.getElementById('case-animation');
        const caseResultEl = document.getElementById('case-result');
        const resultImageEl = document.getElementById('result-image');
        const resultTextEl = document.getElementById('result-text');
        const inventoryEl = document.getElementById('inventory');
        const casesSection = document.getElementById('cases-section');
        const inventorySection = document.getElementById('inventory-section');
        const tasksSection = document.getElementById('tasks-section');
        const timerEl = document.getElementById('timer');
        const showCasesBtn = document.getElementById('show-cases');
        const showInventoryBtn = document.getElementById('show-inventory');
        const showTasksBtn = document.getElementById('show-tasks');

        // Обновление баланса звезд
        function updateStarBalance() {
            starBalanceEl.textContent = starBalance;
            console.log('Баланс обновлён:', starBalance);
        }

        // Обновление инвентаря
        function updateInventory() {
            inventoryEl.innerHTML = '';
            inventory.forEach(item => {
                const gift = gifts.find(g => g.name === item);
                if (gift) {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'inventory-item';
                    itemEl.innerHTML = `
                        <img src="${gift.image}" alt="${gift.name}">
                        <div>
                            <p>${gift.name}</p>
                            <p>${gift.value} звезд</p>
                        </div>
                    `;
                    inventoryEl.appendChild(itemEl);
                }
            });
            console.log('Инвентарь обновлён:', inventory);
        }

        // Выбор случайных заданий
        function selectDailyTasks() {
            try {
                dailyTasks = [];
                const shuffled = taskPool.sort(() => 0.5 - Math.random());
                dailyTasks = shuffled.slice(0, 3).map(task => ({
                    id: task.id,
                    description: task.description,
                    goal: task.goal,
                    reward: task.reward,
                    completed: false,
                    progress: 0
                }));
                lastTaskUpdate = new Date().toISOString().split('T')[0];
                localStorage.setItem('dailyTasks', JSON.stringify(dailyTasks));
                localStorage.setItem('lastTaskUpdate', lastTaskUpdate);
                console.log('Задания выбраны:', dailyTasks);
                updateTasks();
            } catch (e) {
                console.error('Ошибка при выборе заданий:', e);
            }
        }

        // Обновление заданий
        function updateTasks() {
            const tasksEl = document.getElementById('tasks');
            tasksEl.innerHTML = '';
            dailyTasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'task';
                taskEl.innerHTML = `
                    <p>${task.description}</p>
                    <p>Прогресс: ${task.progress}/${task.goal} | Награда: ${task.reward} звезд</p>
                    <button class="claim-task" data-task="${task.id}" ${task.progress >= task.goal && !task.completed ? '' : 'disabled'}>Получить</button>
                `;
                tasksEl.appendChild(taskEl);
            });

            // Обработчики кнопок заданий
            document.querySelectorAll('.claim-task').forEach(button => {
                button.addEventListener('click', () => {
                    console.log('Клик по кнопке задания:', button.getAttribute('data-task'));
                    const taskId = button.getAttribute('data-task');
                    const task = dailyTasks.find(t => t.id === taskId);
                    if (task.progress >= task.goal && !task.completed) {
                        starBalance += task.reward;
                        task.completed = true;
                        updateStarBalance();
                        updateTasks();
                        alert(`Задание выполнено! Получено ${task.reward} звезд.`);
                    }
                });
            });
            console.log('Задания обновлены:', dailyTasks);
        }

        // Таймер до следующего обновления (00:00 MSK)
        function updateTimer() {
            try {
                const now = new Date();
                const mskOffset = 3 * 60 * 60 * 1000; // MSK = UTC+3
                const utc = now.getTime() + (now.getTimezoneOffset() * 60 * 1000);
                const mskTime = new Date(utc + mskOffset);
                const nextMidnight = new Date(mskTime);
                nextMidnight.setHours(24, 0, 0, 0);
                const timeLeft = nextMidnight - mskTime;

                if (timeLeft <= 0) {
                    selectDailyTasks();
                    return;
                }

                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                timerEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                // Проверка обновления заданий
                const today = mskTime.toISOString().split('T')[0];
                if (lastTaskUpdate !== today) {
                    selectDailyTasks();
                }
            } catch (e) {
                console.error('Ошибка таймера:', e);
            }
        }

        // Случайный выбор подарка
        function getRandomGift(caseData) {
            const rand = Math.random();
            let cumulative = 0;
            for (const drop of caseData.drops) {
                cumulative += drop.chance;
                if (rand <= cumulative) {
                    return drop.gift;
                }
            }
            return caseData.drops[0].gift; // Запасной вариант
        }

        // Открытие кейса
        function openCase(caseData) {
            console.log('Открытие кейса:', caseData.name);
            if (starBalance >= caseData.cost) {
                starBalance -= caseData.cost;
                updateStarBalance();

                // Обновление прогресса заданий
                dailyTasks.forEach(task => {
                    if (task.id === "open-5-cases" || task.id === "open-3-cases") task.progress++;
                    if (task.id === "beginner-3-gifts" && caseData.name === "Кейс Новичка") task.progress++;
                    if (task.id === "open-legend" && caseData.name === "Кейс Легенды") task.progress++;
                    if (task.id === "open-2-space" && caseData.name === "Космический кейс") task.progress++;
                    if (task.id === "open-pro" && caseData.name === "Кейс Профессионала") task.progress++;
                    if (task.id === "holiday-2-gifts" && caseData.name === "Праздничный кейс") task.progress++;
                    if (task.id === "amateur-5-gifts" && caseData.name === "Кейс Любителя") task.progress++;
                    const giftName = getRandomGift(caseData);
                    const gift = gifts.find(g => g.name === giftName);
                    if (task.id === "gift-100-plus" && gift.value >= 100) task.progress++;
                });

                // Показ анимации
                caseAnimationEl.style.display = 'flex';
                caseResultEl.style.display = 'none';
                openBeginnerCaseBtn.disabled = true;
                openAmateurCaseBtn.disabled = true;
                openProCaseBtn.disabled = true;
                openLegendCaseBtn.disabled = true;
                openSpaceCaseBtn.disabled = true;
                openHolidayCaseBtn.disabled = true;

                // Симуляция открытия кейса
                setTimeout(() => {
                    const giftName = getRandomGift(caseData);
                    const gift = gifts.find(g => g.name === giftName);
                    inventory.push(giftName);
                    updateInventory();

                    caseAnimationEl.style.display = 'none';
                    resultImageEl.src = gift.image;
                    resultTextEl.textContent = `Вы получили: ${gift.name}!`;
                    caseResultEl.style.display = 'block';
                    openBeginnerCaseBtn.disabled = false;
                    openAmateurCaseBtn.disabled = false;
                    openProCaseBtn.disabled = false;
                    openLegendCaseBtn.disabled = false;
                    openSpaceCaseBtn.disabled = false;
                    openHolidayCaseBtn.disabled = false;
                    console.log('Кейс открыт, получен:', giftName);
                }, 2000);
            } else {
                alert('Недостаточно звезд!');
                console.log('Недостаточно звезд для кейса:', caseData.name);
            }
            updateTasks();
        }

        // Обработчики кнопок кейсов
        openBeginnerCaseBtn.addEventListener('click', () => {
            console.log('Клик: Кейс Новичка');
            openCase(cases[0]);
        });
        openAmateurCaseBtn.addEventListener('click', () => {
            console.log('Клик: Кейс Любителя');
            openCase(cases[1]);
        });
        openProCaseBtn.addEventListener('click', () => {
            console.log('Клик: Кейс Профессионала');
            openCase(cases[2]);
        });
        openLegendCaseBtn.addEventListener('click', () => {
            console.log('Клик: Кейс Легенды');
            openCase(cases[3]);
        });
        openSpaceCaseBtn.addEventListener('click', () => {
            console.log('Клик: Космический кейс');
            openCase(cases[4]);
        });
        openHolidayCaseBtn.addEventListener('click', () => {
            console.log('Клик: Праздничный кейс');
            openCase(cases[5]);
        });

        // Навигация между экранами
        showCasesBtn.addEventListener('click', () => {
            console.log('Клик: Показать кейсы');
            casesSection.style.display = 'block';
            inventorySection.style.display = 'none';
            tasksSection.style.display = 'none';
            showCasesBtn.classList.add('active');
            showInventoryBtn.classList.remove('active');
            showTasksBtn.classList.remove('active');
        });
        showInventoryBtn.addEventListener('click', () => {
            console.log('Клик: Показать инвентарь');
            casesSection.style.display = 'none';
            inventorySection.style.display = 'block';
            tasksSection.style.display = 'none';
            showCasesBtn.classList.remove('active');
            showInventoryBtn.classList.add('active');
            showTasksBtn.classList.remove('active');
            dailyTasks.forEach(task => {
                if (task.id === "visit-inventory") task.progress++;
            });
            updateTasks();
        });
        showTasksBtn.addEventListener('click', () => {
            console.log('Клик: Показать задания');
            casesSection.style.display = 'none';
            inventorySection.style.display = 'none';
            tasksSection.style.display = 'block';
            showCasesBtn.classList.remove('active');
            showInventoryBtn.classList.remove('active');
            showTasksBtn.classList.add('active');
        });

        // Инициализация заданий
        try {
            const storedTasks = localStorage.getItem('dailyTasks');
            lastTaskUpdate = localStorage.getItem('lastTaskUpdate');
            if (storedTasks && lastTaskUpdate === new Date().toISOString().split('T')[0]) {
                dailyTasks = JSON.parse(storedTasks);
                console.log('Задания загружены из localStorage:', dailyTasks);
            } else {
                selectDailyTasks();
            }
        } catch (e) {
            console.error('Ошибка при загрузке заданий:', e);
            selectDailyTasks();
        }

        // Запуск таймера
        updateTimer();
        setInterval(updateTimer, 1000);

        // Инициализация
        updateStarBalance();
        updateInventory();
        updateTasks();
        console.log('Приложение инициализировано');
    </script>
</body>
</html>